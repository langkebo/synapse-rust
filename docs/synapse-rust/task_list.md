# Synapse Rust 项目优化任务列表

> **版本**：1.0.0  
> **创建日期**：2026-02-24  
> **预计工期**：6 周

---

## 一、E2EE 双棘轮算法优化（第 1-2 周）

### 1.1 Olm 存储层实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| E2EE-001 | 创建 `src/e2ee/olm/storage.rs` 文件 | 高 | 待开始 | 2h |
| E2EE-002 | 实现 `OlmStorage` 结构体 | 高 | 待开始 | 4h |
| E2EE-003 | 实现 `save_account` 方法 | 高 | 待开始 | 2h |
| E2EE-004 | 实现 `load_account` 方法 | 高 | 待开始 | 2h |
| E2EE-005 | 实现 `save_session` 方法 | 高 | 待开始 | 2h |
| E2EE-006 | 实现 `load_sessions` 方法 | 高 | 待开始 | 2h |
| E2EE-007 | 实现 `delete_session` 方法 | 中 | 待开始 | 1h |
| E2EE-008 | 编写存储层单元测试 | 高 | 待开始 | 4h |

### 1.2 Olm 数据模型扩展

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| E2EE-009 | 扩展 `models.rs` 添加 `OlmSessionData` | 高 | 待开始 | 1h |
| E2EE-010 | 扩展 `models.rs` 添加 `OlmAccountData` | 高 | 待开始 | 1h |
| E2EE-011 | 实现 `OlmSessionData` 序列化/反序列化 | 高 | 待开始 | 2h |
| E2EE-012 | 实现 `OlmAccountData` 序列化/反序列化 | 高 | 待开始 | 2h |

### 1.3 Olm 会话管理实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| E2EE-013 | 创建 `src/e2ee/olm/session.rs` 文件 | 高 | 待开始 | 1h |
| E2EE-014 | 实现 `OlmSessionManager` 结构体 | 高 | 待开始 | 3h |
| E2EE-015 | 实现会话创建方法 | 高 | 待开始 | 3h |
| E2EE-016 | 实现会话恢复方法 | 高 | 待开始 | 3h |
| E2EE-017 | 实现会话持久化方法 | 高 | 待开始 | 2h |
| E2EE-018 | 实现会话过期清理 | 中 | 待开始 | 2h |
| E2EE-019 | 编写会话管理单元测试 | 高 | 待开始 | 4h |

### 1.4 OlmService 扩展

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| E2EE-020 | 集成 `OlmStorage` 到 `OlmService` | 高 | 待开始 | 2h |
| E2EE-021 | 集成 `OlmSessionManager` 到 `OlmService` | 高 | 待开始 | 2h |
| E2EE-022 | 实现账户持久化 | 高 | 待开始 | 2h |
| E2EE-023 | 实现批量密钥生成 | 中 | 待开始 | 2h |
| E2EE-024 | 实现与 to_device 集成 | 高 | 待开始 | 4h |
| E2EE-025 | 编写集成测试 | 高 | 待开始 | 4h |

### 1.5 数据库迁移

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| E2EE-026 | 创建 `olm_accounts` 表迁移 | 高 | 待开始 | 1h |
| E2EE-027 | 创建 `olm_sessions` 表迁移 | 高 | 待开始 | 1h |
| E2EE-028 | 添加必要索引 | 中 | 待开始 | 1h |
| E2EE-029 | 编写迁移回滚脚本 | 中 | 待开始 | 1h |

---

## 二、Workers 架构优化（第 3-4 周）

### 2.1 Redis Pub/Sub 消息总线

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| WORKER-001 | 创建 `src/worker/bus.rs` 文件 | 高 | 待开始 | 1h |
| WORKER-002 | 实现 `WorkerBus` 结构体 | 高 | 待开始 | 3h |
| WORKER-003 | 实现 `publish` 方法 | 高 | 待开始 | 2h |
| WORKER-004 | 实现 `subscribe` 方法 | 高 | 待开始 | 3h |
| WORKER-005 | 实现 `broadcast_command` 方法 | 高 | 待开始 | 2h |
| WORKER-006 | 实现 `send_to_worker` 方法 | 高 | 待开始 | 2h |
| WORKER-007 | 实现重连机制 | 高 | 待开始 | 3h |
| WORKER-008 | 实现消息确认机制 | 中 | 待开始 | 2h |
| WORKER-009 | 编写消息总线单元测试 | 高 | 待开始 | 4h |

### 2.2 流写入器管理

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| WORKER-010 | 创建 `src/worker/stream.rs` 文件 | 高 | 待开始 | 1h |
| WORKER-011 | 实现 `StreamWriterManager` 结构体 | 高 | 待开始 | 2h |
| WORKER-012 | 实现 `get_writer` 方法 | 高 | 待开始 | 2h |
| WORKER-013 | 实现 `is_local_writer` 方法 | 高 | 待开始 | 1h |
| WORKER-014 | 实现 `forward_to_writer` 方法 | 高 | 待开始 | 3h |
| WORKER-015 | 实现流位置同步 | 高 | 待开始 | 3h |
| WORKER-016 | 编写流管理单元测试 | 高 | 待开始 | 3h |

### 2.3 负载均衡

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| WORKER-017 | 创建 `src/worker/load_balancer.rs` 文件 | 高 | 待开始 | 1h |
| WORKER-018 | 实现 `WorkerLoadBalancer` 结构体 | 高 | 待开始 | 2h |
| WORKER-019 | 实现 `LoadBalanceStrategy` 枚举 | 高 | 待开始 | 1h |
| WORKER-020 | 实现轮询策略 | 高 | 待开始 | 2h |
| WORKER-021 | 实现最少连接策略 | 中 | 待开始 | 2h |
| WORKER-022 | 实现 `select_worker` 方法 | 高 | 待开始 | 2h |
| WORKER-023 | 实现 `update_worker_load` 方法 | 高 | 待开始 | 1h |
| WORKER-024 | 编写负载均衡单元测试 | 高 | 待开始 | 3h |

### 2.4 健康检查

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| WORKER-025 | 创建 `src/worker/health.rs` 文件 | 中 | 待开始 | 1h |
| WORKER-026 | 实现 `HealthChecker` 结构体 | 中 | 待开始 | 2h |
| WORKER-027 | 实现心跳检测 | 中 | 待开始 | 2h |
| WORKER-028 | 实现故障转移 | 中 | 待开始 | 3h |
| WORKER-029 | 编写健康检查单元测试 | 中 | 待开始 | 2h |

### 2.5 WorkerManager 扩展

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| WORKER-030 | 集成 `WorkerBus` 到 `WorkerManager` | 高 | 待开始 | 2h |
| WORKER-031 | 集成 `StreamWriterManager` | 高 | 待开始 | 2h |
| WORKER-032 | 集成 `WorkerLoadBalancer` | 高 | 待开始 | 2h |
| WORKER-033 | 集成 `HealthChecker` | 中 | 待开始 | 2h |
| WORKER-034 | 编写集成测试 | 高 | 待开始 | 4h |

---

## 三、Push 通知优化（第 5-6 周）

### 3.1 FCM Provider 实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| PUSH-001 | 创建 `src/services/push/` 目录结构 | 高 | 待开始 | 1h |
| PUSH-002 | 创建 `src/services/push/providers/fcm.rs` | 高 | 待开始 | 1h |
| PUSH-003 | 实现 `FcmProvider` 结构体 | 高 | 待开始 | 2h |
| PUSH-004 | 实现 `send` 方法 | 高 | 待开始 | 3h |
| PUSH-005 | 实现 `send_batch` 方法 | 中 | 待开始 | 2h |
| PUSH-006 | 实现错误处理和重试 | 高 | 待开始 | 2h |
| PUSH-007 | 编写 FCM 单元测试 | 高 | 待开始 | 3h |

### 3.2 APNs Provider 实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| PUSH-008 | 创建 `src/services/push/providers/apns.rs` | 高 | 待开始 | 1h |
| PUSH-009 | 实现 `ApnsProvider` 结构体 | 高 | 待开始 | 2h |
| PUSH-010 | 实现 JWT 生成 | 高 | 待开始 | 3h |
| PUSH-011 | 实现 `send` 方法 | 高 | 待开始 | 3h |
| PUSH-012 | 实现错误处理和重试 | 高 | 待开始 | 2h |
| PUSH-013 | 编写 APNs 单元测试 | 高 | 待开始 | 3h |

### 3.3 Web Push Provider 实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| PUSH-014 | 创建 `src/services/push/providers/webpush.rs` | 高 | 待开始 | 1h |
| PUSH-015 | 实现 `WebPushProvider` 结构体 | 高 | 待开始 | 2h |
| PUSH-016 | 实现 VAPID JWT 生成 | 高 | 待开始 | 3h |
| PUSH-017 | 实现负载加密 | 高 | 待开始 | 3h |
| PUSH-018 | 实现 `send` 方法 | 高 | 待开始 | 3h |
| PUSH-019 | 编写 Web Push 单元测试 | 高 | 待开始 | 3h |

### 3.4 Push Gateway 协议实现

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| PUSH-020 | 创建 `src/services/push/gateway.rs` | 高 | 待开始 | 1h |
| PUSH-021 | 实现 `PushGateway` 结构体 | 高 | 待开始 | 2h |
| PUSH-022 | 实现通知格式构建 | 高 | 待开始 | 2h |
| PUSH-023 | 实现 `send_notification` 方法 | 高 | 待开始 | 3h |
| PUSH-024 | 实现响应处理 | 高 | 待开始 | 2h |
| PUSH-025 | 编写 Gateway 单元测试 | 高 | 待开始 | 3h |

### 3.5 Push 服务重构

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| PUSH-026 | 重构 `PushNotificationService` | 高 | 待开始 | 3h |
| PUSH-027 | 集成各 Provider | 高 | 待开始 | 2h |
| PUSH-028 | 实现推送队列管理 | 高 | 待开始 | 3h |
| PUSH-029 | 实现批量发送优化 | 中 | 待开始 | 2h |
| PUSH-030 | 编写集成测试 | 高 | 待开始 | 4h |

---

## 四、文档和测试（贯穿全程）

### 4.1 文档更新

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| DOC-001 | 更新 API 文档 | 中 | 待开始 | 2h |
| DOC-002 | 更新配置文档 | 中 | 待开始 | 2h |
| DOC-003 | 添加代码注释 | 高 | 待开始 | 4h |
| DOC-004 | 更新 README | 低 | 待开始 | 1h |

### 4.2 测试完善

| 任务 ID | 任务描述 | 优先级 | 状态 | 预计时间 |
|---------|---------|--------|------|----------|
| TEST-001 | 编写 E2EE 集成测试 | 高 | 待开始 | 4h |
| TEST-002 | 编写 Worker 集成测试 | 高 | 待开始 | 4h |
| TEST-003 | 编写 Push 集成测试 | 高 | 待开始 | 4h |
| TEST-004 | 性能测试 | 中 | 待开始 | 4h |
| TEST-005 | 安全测试 | 高 | 待开始 | 4h |

---

## 五、任务统计

| 阶段 | 任务数 | 预计时间 |
|------|--------|----------|
| E2EE 优化 | 29 | 52h |
| Workers 优化 | 34 | 58h |
| Push 优化 | 30 | 55h |
| 文档和测试 | 9 | 25h |
| **总计** | **102** | **190h** |

---

## 六、里程碑

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1: E2EE 完成 | 第 2 周末 | Olm 会话持久化、存储层、测试 |
| M2: Workers 完成 | 第 4 周末 | Redis 消息总线、流管理、负载均衡 |
| M3: Push 完成 | 第 6 周末 | FCM/APNs/WebPush 集成、测试 |
| M4: 项目验收 | 第 6 周末 | 完整测试报告、文档 |
