# Synapse Rust é¡¹ç›®ä¼˜åŒ–æ–¹æ¡ˆ

> **ç‰ˆæœ¬**ï¼š1.0.0
> **åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-24
> **é¡¹ç›®çŠ¶æ€**ï¼šå¼€å‘ä¸­
> **å‚è€ƒæ–‡æ¡£**ï¼š[Synapse å®˜æ–¹æ–‡æ¡£](https://element-hq.github.io/synapse/latest/)ã€[Matrix è§„èŒƒ](https://spec.matrix.org/)ã€[vodozemac æ–‡æ¡£](https://crates.io/crates/vodozemac)

---

## ä¸€ã€ä¼˜åŒ–ç›®æ ‡

æ ¹æ®å¯¹æ¯” Synapse å®˜æ–¹æ–‡æ¡£çš„åˆ†æï¼Œæœ¬ä¼˜åŒ–æ–¹æ¡ˆæ—¨åœ¨è§£å†³ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. **E2EE åŒæ£˜è½®ç®—æ³•æœªå®ç°** - å®‰å…¨å…³é”®åŠŸèƒ½ç¼ºå¤±
2. **Workers æ¶æ„ä¸å®Œæ•´** - å½±å“å¯æ‰©å±•æ€§å’Œæ€§èƒ½
3. **Push é€šçŸ¥é›†æˆä¸å®Œæ•´** - å½±å“ç”¨æˆ·ä½“éªŒ

---

## äºŒã€ä¼˜åŒ–æ–¹æ¡ˆè¯¦æƒ…

### 2.1 E2EE åŒæ£˜è½®ç®—æ³•ä¼˜åŒ–

#### 2.1.1 é—®é¢˜åˆ†æ

å½“å‰é¡¹ç›®ä»…å®ç°äº† Megolm ç¾¤ç»„åŠ å¯†ï¼Œç¼ºå°‘ Olm åŒæ£˜è½®ç®—æ³•å®ç°ã€‚Olm æ˜¯ Matrix åè®®ä¸­ä¸€å¯¹ä¸€æ¶ˆæ¯åŠ å¯†çš„æ ¸å¿ƒï¼Œæä¾›äº†å‰å‘ä¿å¯†ï¼ˆForward Secrecyï¼‰å’Œä¼šè¯å¯†é’¥æ£˜è½®æœºåˆ¶ã€‚

#### 2.1.2 ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆé€‰æ‹©**ï¼šé›†æˆ vodozemac åº“

vodozemac æ˜¯çº¯ Rust å®ç°çš„ Olm å’Œ Megolm åŠ å¯†åº“ï¼Œæ˜¯ libolm çš„ç°ä»£æ›¿ä»£å“ï¼Œå·²é€šè¿‡å®‰å…¨å®¡è®¡ã€‚

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- çº¯ Rust å®ç°ï¼Œæ—  C ä¾èµ–
- å†…å­˜å®‰å…¨ï¼Œæ— é‡æŒ‡é’ˆé£é™©
- æ”¯æŒå®Œæ•´çš„ Olm ä¼šè¯ç®¡ç†
- æ”¯æŒæ¶ˆæ¯å¯†é’¥æ´¾ç”Ÿé“¾
- æä¾›å‰å‘ä¿å¯†

**å®æ–½æ­¥éª¤**ï¼š

1. æ·»åŠ ä¾èµ–
```toml
# Cargo.toml
[dependencies]
vodozemac = "0.9"
```

2. åˆ›å»º Olm æœåŠ¡æ¨¡å—
```
src/e2ee/olm/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ service.rs      # Olm ä¼šè¯ç®¡ç†
â”œâ”€â”€ session.rs      # ä¼šè¯çŠ¶æ€ç®¡ç†
â””â”€â”€ models.rs       # æ•°æ®æ¨¡å‹
```

3. å®ç°æ ¸å¿ƒåŠŸèƒ½
- OlmAccount: è´¦æˆ·å¯†é’¥å¯¹ç®¡ç†
- OlmSession: åŒæ£˜è½®ä¼šè¯
- OlmMessage: æ¶ˆæ¯åŠ å¯†/è§£å¯†
- ä¼šè¯çŠ¶æ€åºåˆ—åŒ–

4. é›†æˆåˆ°ç°æœ‰ E2EE æ¶æ„
- æ›¿æ¢ç°æœ‰çš„ç®€åŒ– Megolm å®ç°
- å®ç° to_device æ¶ˆæ¯åŠ å¯†
- æ·»åŠ å¯†é’¥åˆ†å‘æ”¯æŒ

**é¢„ä¼°å·¥ä½œé‡**ï¼š3-4 å‘¨

#### 2.1.3 ä»£ç ç¤ºä¾‹

```rust
use vodozemac::{OlmAccount, OlmMessage, Curve25519PublicKey};

pub struct OlmService {
    account: OlmAccount,
    sessions: HashMap<String, OlmSession>,
}

impl OlmService {
    pub fn new() -> Self {
        Self {
            account: OlmAccount::new(),
            sessions: HashMap::new(),
        }
    }

    pub fn generate_one_time_keys(&mut self, count: usize) -> Vec<Curve25519PublicKey> {
        self.account.generate_one_time_keys(count)
    }

    pub fn create_inbound_session(
        &mut self,
        their_key: Curve25519PublicKey,
    ) -> OlmSession {
        self.account.create_inbound_session(their_key)
    }

    pub fn encrypt_message(&mut self, recipient: &str, plaintext: &[u8]) -> OlmMessage {
        let session = self.sessions.get_mut(recipient).unwrap();
        session.encrypt(plaintext)
    }

    pub fn decrypt_message(
        &mut self,
        sender_key: &Curve25519PublicKey,
        message: &OlmMessage,
    ) -> Result<Vec<u8>, ()> {
        let session = self.account.create_inbound_session_from(sender_key);
        session.decrypt(message)
    }
}
```

---

### 2.2 Workers æ¶æ„ä¼˜åŒ–

#### 2.2.1 é—®é¢˜åˆ†æ

å½“å‰é¡¹ç›®è™½ç„¶å®šä¹‰äº† WorkerConfigï¼Œä½†ç¼ºå°‘å®Œæ•´çš„å¤š Worker éƒ¨ç½²æ”¯æŒï¼š
- ç¼ºå°‘å®ä¾‹é—´é€šä¿¡æœºåˆ¶
- ç¼ºå°‘æµå†™å…¥å™¨åˆ†é…
- ç¼ºå°‘å®Œæ•´çš„è´Ÿè½½å‡è¡¡

#### 2.2.2 ä¼˜åŒ–æ–¹æ¡ˆ

**æ¶æ„è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Synapse Rust Workers                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Main Worker â”‚â”€â”€â”€â”€â–¶â”‚ Federation  â”‚â”€â”€â”€â”€â–¶â”‚  Media      â”‚  â”‚
â”‚  â”‚  (Router)    â”‚     â”‚  Sender     â”‚     â”‚  Worker     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                    â”‚                    â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                    â”‚   Redis Pub/Sub   â”‚                  â”‚
â”‚                    â”‚   (æ¶ˆæ¯æ€»çº¿)       â”‚                  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ–½æ­¥éª¤**ï¼š

1. æ‰©å±• Worker é…ç½®
```rust
// src/common/config.rs
pub struct WorkerConfig {
    pub instance_name: String,
    pub worker_app: Option<String>,
    pub instance_map: HashMap<String, InstanceLocation>,
    pub stream_writers: StreamWriters,
    pub replication_secret: String,
}

pub struct InstanceLocation {
    pub host: String,
    pub port: u16,
    pub scheme: String,
}
```

2. å®ç° TCP å¤åˆ¶åè®®
```rust
// src/worker/protocol.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ReplicationCommand {
    #[serde(rename = "PING")]
    Ping(String),
    #[serde(rename = "PONG")]
    Pong(String, String),
    #[serde(rename = "POSITION")]
    Position(String, u64),
    #[serde(rename = "FEDERATION")]
    Federation(String, Vec<u8>),
    #[serde(rename = "USER_SYNC")]
    UserSync(String, UserSyncData),
}
```

3. å®ç°æ¶ˆæ¯æ€»çº¿
```rust
// src/worker/bus.rs
pub struct WorkerBus {
    redis: Arc<RedisConnectionManager>,
}

impl WorkerBus {
    pub async fn publish(&self, worker: &str, message: &[u8]) -> Result<()> {
        // å‘å¸ƒæ¶ˆæ¯åˆ°æŒ‡å®š Worker
    }

    pub async fn subscribe(&self, workers: &[String]) -> Result<Receiver> {
        // è®¢é˜… Worker æ¶ˆæ¯
    }

    pub async fn broadcast(&self, message: &[u8]) -> Result<()> {
        // å¹¿æ’­åˆ°æ‰€æœ‰ Worker
    }
}
```

**é¢„ä¼°å·¥ä½œé‡**ï¼š4-5 å‘¨

---

### 2.3 Push é€šçŸ¥ä¼˜åŒ–

#### 2.3.1 é—®é¢˜åˆ†æ

å½“å‰é¡¹ç›®ä»…å®ç°äº† Push API ç«¯ç‚¹ï¼Œç¼ºå°‘å®é™…çš„é€šçŸ¥æ¨é€é›†æˆï¼š
- æ—  FCM (Firebase Cloud Messaging) é›†æˆ
- æ—  APNs (Apple Push Notification) é›†æˆ
- æ—  Web Push æ”¯æŒ

#### 2.3.2 ä¼˜åŒ–æ–¹æ¡ˆ

**æ¶æ„è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FCM        â”‚     â”‚   APNs       â”‚     â”‚   Web Push   â”‚
â”‚  (Android)   â”‚     â”‚   (iOS)      â”‚     â”‚  (Browser)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                    â–²                    â–²
       â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚                    Push Service                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Manager    â”‚  â”‚  Router     â”‚  â”‚  Queue      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ–½æ­¥éª¤**ï¼š

1. æ·»åŠ  Push ä¾èµ–
```toml
[dependencies]
fcm = "0.12"
apns2 = "0.8"
web-push = "0.7"
```

2. åˆ›å»º Push æœåŠ¡
```rust
// src/services/push_service.rs
pub enum PushProvider {
    Fcm(FcmClient),
    Apns(ApnsClient),
    WebPush(WebPushClient),
}

pub struct PushService {
    provider: PushProvider,
    queue: PushQueue,
}

impl PushService {
    pub async fn send_notification(&self, pusher: &Pusher, event: &Event) -> Result<()> {
        match &self.provider {
            PushProvider::Fcm(client) => client.send(pusher, event).await,
            PushProvider::Apns(client) => client.send(pusher, event).await,
            PushProvider::WebPush(client) => client.send(pusher, event).await,
        }
    }
}
```

**é¢„ä¼°å·¥ä½œé‡**ï¼š2-3 å‘¨

---

## ä¸‰ã€ä¼˜åŒ–ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | é¢„ä¼°å·¥ä½œé‡ | é‡è¦æ€§ |
|--------|--------|-----------|--------|
| ğŸ”´ é«˜ | E2EE åŒæ£˜è½®ç®—æ³• | 3-4 å‘¨ | å®‰å…¨å…³é”® |
| ğŸŸ¡ ä¸­ | Workers æ¶æ„ | 4-5 å‘¨ | æ€§èƒ½å…³é”® |
| ğŸŸ¡ ä¸­ | Push é€šçŸ¥ | 2-3 å‘¨ | åŠŸèƒ½å…³é”® |
| ğŸŸ¢ ä½ | å…¶ä»–ä¼˜åŒ– | - | å¾…å®š |

---

## å››ã€å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šE2EE ä¼˜åŒ–ï¼ˆç¬¬ 1-4 å‘¨ï¼‰

```
ç¬¬ 1 å‘¨ï¼šä¾èµ–é›†æˆä¸åŸºç¡€ç»“æ„
â”œâ”€ æ·»åŠ  vodozemac ä¾èµ–
â”œâ”€ åˆ›å»º e2ee/olm æ¨¡å—
â””â”€ å®ç°åŸºç¡€æ•°æ®æ¨¡å‹

ç¬¬ 2-3 å‘¨ï¼šOlm æœåŠ¡å®ç°
â”œâ”€ å®ç° OlmAccount ç®¡ç†
â”œâ”€ å®ç° OlmSession ä¼šè¯
â”œâ”€ å®ç°æ¶ˆæ¯åŠ å¯†/è§£å¯†
â””â”€ æ·»åŠ å•å…ƒæµ‹è¯•

ç¬¬ 4 å‘¨ï¼šé›†æˆä¸æµ‹è¯•
â”œâ”€ é›†æˆåˆ° to_device æ¶ˆæ¯
â”œâ”€ é›†æˆåˆ°ç°æœ‰ E2EE æ¶æ„
â””â”€ ç«¯åˆ°ç«¯æµ‹è¯•
```

### é˜¶æ®µ 2ï¼šWorkers ä¼˜åŒ–ï¼ˆç¬¬ 5-9 å‘¨ï¼‰

```
ç¬¬ 5 å‘¨ï¼šé…ç½®æ‰©å±•
â”œâ”€ æ‰©å±• WorkerConfig
â”œâ”€ å®ç°å®ä¾‹å‘ç°
â””â”€ é…ç½®åŠ è½½ä¼˜åŒ–

ç¬¬ 6-7 å‘¨ï¼šå¤åˆ¶åè®®
â”œâ”€ å®Œå–„ ReplicationCommand
â”œâ”€ å®ç° TCP å¤åˆ¶
â”œâ”€ å®ç° Redis Pub/Sub
â””â”€ å•å…ƒæµ‹è¯•

ç¬¬ 8-9 å‘¨ï¼šè´Ÿè½½å‡è¡¡
â”œâ”€ å®ç°è¯·æ±‚è·¯ç”±
â”œâ”€ å®ç°æµåˆ†é…
â””â”€ é›†æˆæµ‹è¯•
```

### é˜¶æ®µ 3ï¼šPush ä¼˜åŒ–ï¼ˆç¬¬ 10-12 å‘¨ï¼‰

```
ç¬¬ 10 å‘¨ï¼šåŸºç¡€æ¶æ„
â”œâ”€ æ·»åŠ  Push ä¾èµ–
â”œâ”€ åˆ›å»º Push æœåŠ¡ç»“æ„
â””â”€ å®ç°æ¶ˆæ¯é˜Ÿåˆ—

ç¬¬ 11 å‘¨ï¼šProvider é›†æˆ
â”œâ”€ å®ç° FCM å®¢æˆ·ç«¯
â”œâ”€ å®ç° APNs å®¢æˆ·ç«¯
â””â”€ å®ç° Web Push å®¢æˆ·ç«¯

ç¬¬ 12 å‘¨ï¼šæµ‹è¯•ä¸ä¼˜åŒ–
â”œâ”€ å•å…ƒæµ‹è¯•
â”œâ”€ é›†æˆæµ‹è¯•
â””â”€ æ€§èƒ½ä¼˜åŒ–
```

---

## äº”ã€éªŒæ”¶æ ‡å‡†

### 5.1 E2EE ä¼˜åŒ–

- [ ] vodozemac ä¾èµ–æˆåŠŸé›†æˆ
- [ ] OlmAccount å¯ç”Ÿæˆå’Œå­˜å‚¨å¯†é’¥
- [ ] OlmSession æ”¯æŒåŒæ£˜è½®åŠ å¯†
- [ ] æ¶ˆæ¯åŠ å¯†/è§£å¯†åŠŸèƒ½æ­£å¸¸
- [ ] æ”¯æŒå‰å‘ä¿å¯†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

### 5.2 Workers ä¼˜åŒ–

- [ ] æ”¯æŒå¤šå®ä¾‹é…ç½®
- [ ] TCP å¤åˆ¶åè®®å·¥ä½œæ­£å¸¸
- [ ] Redis æ¶ˆæ¯æ€»çº¿å·¥ä½œæ­£å¸¸
- [ ] å®ä¾‹é—´é€šä¿¡æ­£å¸¸
- [ ] æ”¯æŒæ°´å¹³æ‰©å±•

### 5.3 Push ä¼˜åŒ–

- [ ] FCM æ¨é€æ­£å¸¸å·¥ä½œ
- [ ] APNs æ¨é€æ­£å¸¸å·¥ä½œ
- [ ] Web Push æ­£å¸¸å·¥ä½œ
- [ ] æ¶ˆæ¯é˜Ÿåˆ—ä¸ä¸¢å¤±é€šçŸ¥

---

## å…­ã€é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| vodozemac API å˜æ›´ | ä¸­ | é”å®šç‰ˆæœ¬ï¼Œè¯¦ç»†æµ‹è¯• |
| Worker çŠ¶æ€ä¸€è‡´æ€§ | é«˜ | ä½¿ç”¨ Redis åˆ†å¸ƒå¼é” |
| Push é€šçŸ¥å»¶è¿Ÿ | ä¸­ | å®ç°æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†² |
| ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ– | é«˜ | å®ç°é™çº§ç­–ç•¥ |

---

## ä¸ƒã€æ€»ç»“

æœ¬ä¼˜åŒ–æ–¹æ¡ˆé’ˆå¯¹ Synapse Rust é¡¹ç›®ä¸ Synapse å®˜æ–¹æ–‡æ¡£å¯¹æ¯”å‘ç°çš„å…³é”®å·®è·ï¼Œåˆ¶å®šäº†è¯¦ç»†çš„å®æ–½è®¡åˆ’ï¼š

1. **E2EE åŒæ£˜è½®ç®—æ³•**ï¼šé€šè¿‡é›†æˆ vodozemac åº“ï¼Œå®Œæ•´å®ç° Olm åè®®ï¼Œæä¾›å‰å‘ä¿å¯†
2. **Workers æ¶æ„**ï¼šå®Œå–„å¤š Worker éƒ¨ç½²æ”¯æŒï¼Œæå‡å¯æ‰©å±•æ€§å’Œæ€§èƒ½
3. **Push é€šçŸ¥**ï¼šé›†æˆ FCM/APNs/Web Pushï¼Œæä¾›å®Œæ•´çš„æ¨é€æ”¯æŒ

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºå®æ–½ï¼Œé¢„è®¡æ€»å·¥ä½œé‡ 12 å‘¨ã€‚
