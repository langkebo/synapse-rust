# 数据库脚本优化任务清单

## 任务列表

| ID | 任务描述 | 优先级 | 状态 | 依赖 |
|----|----------|--------|------|------|
| T1 | 分析现有迁移脚本问题 | 高 | 待执行 | - |
| T2 | 创建统一初始化迁移脚本 | 高 | 待执行 | T1 |
| T3 | 修复表结构不匹配问题 | 高 | 待执行 | T2 |
| T4 | 创建缺失的数据库表 | 高 | 待执行 | T2 |
| T5 | 清理冗余迁移脚本 | 中 | 待执行 | T3, T4 |
| T6 | 执行迁移脚本验证 | 高 | 待执行 | T5 |
| T7 | 运行API测试验证 | 高 | 待执行 | T6 |
| T8 | 更新文档 | 中 | 待执行 | T7 |

## 详细任务说明

### T1: 分析现有迁移脚本问题

**输入**: 现有迁移脚本目录
**输出**: 问题分析报告

**步骤**:
1. 列出所有迁移脚本
2. 分析每个脚本的表定义
3. 识别列名冲突
4. 识别缺失的表和列
5. 识别执行顺序问题

**验证标准**:
- 问题清单完整
- 每个问题有明确的修复建议

---

### T2: 创建统一初始化迁移脚本

**输入**: 问题分析报告
**输出**: 新的统一迁移脚本

**步骤**:
1. 创建核心表脚本 (users, devices, access_tokens)
2. 创建房间和成员表脚本
3. 创建事件表脚本
4. 创建E2EE密钥表脚本
5. 创建媒体和语音表脚本
6. 创建推送通知表脚本
7. 创建扩展功能表脚本
8. 创建性能索引脚本

**验证标准**:
- 所有表定义完整
- 外键约束正确
- 索引创建在表创建之后

---

### T3: 修复表结构不匹配问题

**输入**: 统一迁移脚本
**输出**: 修复后的表结构

**步骤**:
1. 修复 voice_messages 表 (processed_ts, mime_type, encryption)
2. 修复 rooms 表 (join_rules)
3. 修复 events 表 (type 列)
4. 修复 refresh_tokens 表 (列名统一)
5. 修复 event_reports 表 (列名统一)

**验证标准**:
- 代码期望的列全部存在
- 列名与代码一致

---

### T4: 创建缺失的数据库表

**输入**: 统一迁移脚本
**输出**: 新创建的表

**步骤**:
1. 创建 pushers 表
2. 创建 push_rules 表
3. 创建 room_members 表
4. 插入默认推送规则数据

**验证标准**:
- 所有表创建成功
- 默认数据插入成功

---

### T5: 清理冗余迁移脚本

**输入**: 新旧迁移脚本
**输出**: 清理后的迁移目录

**步骤**:
1. 备份旧迁移脚本
2. 删除重复定义的脚本
3. 保留必要的增量迁移
4. 更新迁移版本号

**验证标准**:
- 无重复表定义
- 迁移顺序正确

---

### T6: 执行迁移脚本验证

**输入**: 清理后的迁移脚本
**输出**: 迁移执行结果

**步骤**:
1. 删除现有数据库卷
2. 启动数据库容器
3. 执行迁移脚本
4. 检查执行日志
5. 验证表结构

**验证标准**:
- 迁移执行无错误
- 日志无警告
- 所有表创建成功

---

### T7: 运行API测试验证

**输入**: 运行中的服务
**输出**: API测试结果

**步骤**:
1. 启动服务
2. 执行健康检查
3. 运行语音消息API测试
4. 运行推送通知API测试
5. 运行搜索API测试
6. 运行媒体管理API测试

**验证标准**:
- 服务启动成功
- 健康检查通过
- API测试全部通过

---

### T8: 更新文档

**输入**: 优化结果
**输出**: 更新后的文档

**步骤**:
1. 更新 api-error.md (标记已修复的问题)
2. 更新数据库架构文档
3. 更新迁移脚本说明

**验证标准**:
- 文档与实际一致
- 问题状态正确

## 执行时间估计

| 任务 | 预计时间 |
|------|----------|
| T1 | 30分钟 |
| T2 | 2小时 |
| T3 | 1小时 |
| T4 | 30分钟 |
| T5 | 30分钟 |
| T6 | 30分钟 |
| T7 | 1小时 |
| T8 | 30分钟 |
| **总计** | **6.5小时** |

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 数据丢失 | 高 | 执行前备份数据库 |
| 迁移失败 | 中 | 使用事务，支持回滚 |
| 服务无法启动 | 高 | 保留旧镜像，支持快速回滚 |
| API兼容性问题 | 中 | 完整测试后再部署 |
