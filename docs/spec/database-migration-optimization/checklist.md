# 数据库迁移优化检查清单

## 阶段一: 紧急修复检查清单

### 1.1 SQL 语句分割器修复

- [ ] **代码审查**
  - [ ] 检查状态机实现是否完整
  - [ ] 检查所有状态转换是否正确
  - [ ] 检查边界情况处理

- [ ] **功能测试**
  - [ ] 测试单行注释处理
  - [ ] 测试块注释处理
  - [ ] 测试嵌套块注释处理
  - [ ] 测试文件末尾块注释处理
  - [ ] 测试单引号字符串处理
  - [ ] 测试双引号字符串处理
  - [ ] 测试 Dollar-quoted 字符串处理
  - [ ] 测试转义字符处理

- [ ] **回归测试**
  - [ ] 所有现有迁移文件解析成功
  - [ ] 解析结果与预期一致
  - [ ] 无性能退化

### 1.2 迁移文件修复

- [ ] **语法检查**
  - [ ] PostgreSQL 语法验证通过
  - [ ] 无未终止的注释
  - [ ] 无未终止的字符串
  - [ ] DO 块语法正确

- [ ] **执行测试**
  - [ ] 迁移文件可成功执行
  - [ ] 无错误日志
  - [ ] 数据库状态正确

### 1.3 索引修复

- [ ] **索引验证**
  - [ ] 所有索引引用的列存在
  - [ ] 所有索引引用的表存在
  - [ ] 索引谓词中的函数标记为 IMMUTABLE

- [ ] **执行测试**
  - [ ] 索引创建成功
  - [ ] 无警告日志
  - [ ] 查询性能正常

---

## 阶段二: Schema 统一检查清单

### 2.1 统一 Schema 文件

- [ ] **完整性检查**
  - [ ] 包含所有必需的表
  - [ ] 包含所有必需的列
  - [ ] 包含所有必需的索引
  - [ ] 包含所有必需的约束

- [ ] **一致性检查**
  - [ ] 与代码中的结构体定义一致
  - [ ] 与 API 返回的数据结构一致
  - [ ] 与前端期望的数据结构一致

- [ ] **兼容性检查**
  - [ ] 现有数据可正确迁移
  - [ ] 现有查询可正常执行
  - [ ] 现有索引可正常使用

### 2.2 表定义冲突修复

- [ ] **列名统一**
  - [ ] `users.admin` → `users.is_admin` 迁移完成
  - [ ] 所有代码引用已更新
  - [ ] 兼容性视图已创建

- [ ] **主键统一**
  - [ ] `devices` 表主键定义统一
  - [ ] `friends` 表主键定义统一
  - [ ] 外键引用已更新

- [ ] **缺失列添加**
  - [ ] `access_tokens.invalidated` 列已添加
  - [ ] `refresh_tokens.invalidated` 列已添加
  - [ ] 默认值已设置

### 2.3 依赖代码更新

- [ ] **代码搜索**
  - [ ] 搜索所有 `admin` 列引用
  - [ ] 搜索所有 `invalidated` 列引用
  - [ ] 搜索所有硬编码的表结构

- [ ] **代码更新**
  - [ ] 所有引用已更新
  - [ ] 编译无错误
  - [ ] 测试通过

---

## 阶段三: 迁移系统重构检查清单

### 3.1 迁移版本控制

- [ ] **表创建**
  - [ ] `schema_migrations` 表创建成功
  - [ ] 表结构正确
  - [ ] 索引创建成功

- [ ] **功能验证**
  - [ ] 迁移版本记录正确
  - [ ] 迁移版本检查正确
  - [ ] 迁移跳过功能正常
  - [ ] Checksum 验证正确

### 3.2 事务管理

- [ ] **事务测试**
  - [ ] 成功迁移提交正确
  - [ ] 失败迁移回滚正确
  - [ ] 部分失败回滚正确
  - [ ] 事务隔离级别正确

- [ ] **错误处理**
  - [ ] 错误信息清晰
  - [ ] 错误日志完整
  - [ ] 错误恢复机制正常

### 3.3 回滚机制

- [ ] **回滚脚本**
  - [ ] 每个迁移有对应回滚脚本
  - [ ] 回滚脚本语法正确
  - [ ] 回滚脚本执行成功

- [ ] **回滚测试**
  - [ ] 单个迁移回滚成功
  - [ ] 多个迁移回滚成功
  - [ ] 回滚后数据库状态正确

### 3.4 并发保护

- [ ] **锁机制测试**
  - [ ] 锁获取成功
  - [ ] 锁释放正确
  - [ ] 锁超时处理正确
  - [ ] 死锁检测正常

- [ ] **并发测试**
  - [ ] 单实例启动正常
  - [ ] 多实例启动正常
  - [ ] 无竞态条件

---

## 阶段四: 性能优化检查清单

### 4.1 执行顺序优化

- [ ] **依赖分析**
  - [ ] 所有迁移依赖已识别
  - [ ] 依赖图构建正确
  - [ ] 拓扑排序正确

- [ ] **性能测试**
  - [ ] 执行时间减少
  - [ ] 无性能退化

### 4.2 并行迁移

- [ ] **并行测试**
  - [ ] 并行执行正确
  - [ ] 无数据竞争
  - [ ] 无死锁

- [ ] **性能测试**
  - [ ] 并行执行时间 < 串行执行时间
  - [ ] 资源使用正常

### 4.3 性能监控

- [ ] **监控功能**
  - [ ] 执行时间记录正确
  - [ ] 性能指标收集正确
  - [ ] 性能报告生成正确

---

## 阶段五: 测试与验证检查清单

### 5.1 单元测试

- [ ] **测试覆盖**
  - [ ] SQL 分割器测试覆盖率 > 90%
  - [ ] Schema 验证测试覆盖率 > 90%
  - [ ] 迁移版本控制测试覆盖率 > 90%
  - [ ] 事务管理测试覆盖率 > 90%

- [ ] **测试结果**
  - [ ] 所有测试通过
  - [ ] 无测试警告
  - [ ] 无测试跳过

### 5.2 集成测试

- [ ] **测试场景**
  - [ ] 全新数据库初始化
  - [ ] 现有数据库迁移
  - [ ] 迁移回滚
  - [ ] 并发迁移

- [ ] **测试结果**
  - [ ] 所有场景通过
  - [ ] 无数据丢失
  - [ ] 无数据损坏

### 5.3 数据完整性验证

- [ ] **Schema 对比**
  - [ ] 所有表存在
  - [ ] 所有列存在
  - [ ] 所有索引存在
  - [ ] 所有约束存在

- [ ] **数据验证**
  - [ ] 数据类型正确
  - [ ] 数据约束满足
  - [ ] 外键关系正确

---

## 最终验收检查清单

### 功能验收

- [ ] 所有迁移文件执行成功
- [ ] 无错误日志
- [ ] 无警告日志
- [ ] 数据库状态正确

### 性能验收

- [ ] 迁移执行时间 < 1 秒
- [ ] 启动时间 < 30 秒
- [ ] 内存使用正常
- [ ] CPU 使用正常

### 安全验收

- [ ] 无 SQL 注入风险
- [ ] 无数据泄露风险
- [ ] 无权限提升风险

### 文档验收

- [ ] 规范文档完整
- [ ] 任务列表完整
- [ ] 检查清单完整
- [ ] 回滚文档完整

### 部署验收

- [ ] Docker 构建成功
- [ ] Docker 运行正常
- [ ] 健康检查通过
- [ ] API 响应正常
