# Synapse-Rust 项目综合审查任务列表

> **创建日期**: 2026-02-23
> **预计完成**: 8 周
> **最后更新**: 2026-02-23

---

## Phase 1: 严重问题修复 (2 周)

### T1-001 数据库 Schema 不一致修复
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] 审查所有 SQL 查询语句
  - [x] 创建迁移脚本 `20260223000001_unify_events_fields.sql`
  - [x] 统一字段命名 (`type` → `event_type`)
  - [x] 添加缺失的列 (processed_ts, not_before, status 等)
  - [x] 添加外键约束和索引
- **验收标准**: 迁移脚本已创建 ✅

### T1-002 外键约束冲突修复
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] 代码已有完整的错误处理机制
  - [x] 使用事务包装器确保原子性
  - [x] 外键错误已正确处理
- **验收标准**: 错误处理已实现 ✅

### T1-003 联邦客户端初始化
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] `FriendFederationClient::new()` 已实现
  - [x] HTTP 客户端配置完整
  - [x] 签名密钥加载已实现
  - [x] 联邦通信方法完整
- **验收标准**: 联邦客户端已实现 ✅

---

## Phase 2: 高优先级问题修复 (3 周)

### T2-001 错误处理规范化
- **优先级**: P1
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] 完整的 `ApiError` 枚举实现
  - [x] 错误类型映射到 Matrix 错误码
  - [x] 错误响应格式符合 Matrix 规范
  - [x] 完整的错误处理测试
- **验收标准**: 错误响应符合 Matrix 规范 ✅

### T2-002 输入验证增强
- **优先级**: P1
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] `Validator` 结构体实现
  - [x] 用户 ID 格式验证
  - [x] 房间 ID 格式验证
  - [x] 密码强度验证
  - [x] `ValidationContext` 链式验证
  - [x] 属性测试 (quickcheck)
- **验收标准**: 所有输入经过验证 ✅

### T2-003 配置安全性增强
- **优先级**: P1
- **状态**: ⏳ 部分完成
- **任务内容**:
  - [x] 敏感配置支持环境变量
  - [x] 密钥路径配置支持
  - [ ] 添加配置验证逻辑
  - [ ] 审查默认值安全性
- **验收标准**: 配置安全审计通过

### T2-004 速率限制实现
- **优先级**: P1
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] `rate_limit_middleware` 中间件实现
  - [x] Redis 分布式限流
  - [x] 本地限流回退
  - [x] 限流响应头
  - [x] 限流配置
- **验收标准**: API 限流正常工作 ✅

### T2-005 数据库连接池优化
- **优先级**: P1
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] `ConnectionPoolConfig` 配置结构
  - [x] 开发/生产/高负载预设配置
  - [x] 连接池健康检查
  - [x] 连接池监控
- **验收标准**: 连接池配置完善 ✅

---

## Phase 3: 中优先级问题修复 (2 周)

### T3-001 日志记录完善
- **优先级**: P2
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] 使用 `tracing` 结构化日志
  - [x] `DistributedTracer` 分布式追踪
  - [x] OpenTelemetry 集成
  - [x] Jaeger 追踪支持
- **验收标准**: 日志格式统一，支持分布式追踪 ✅

### T3-002 健康检查端点
- **优先级**: P2
- **状态**: ✅ 已完成
- **任务内容**:
  - [x] `/health` 端点实现
  - [x] `HealthChecker` 组件
  - [x] 数据库连接状态检查
  - [x] Redis 连接状态检查
  - [x] 定期健康检查任务
- **验收标准**: K8s 健康检查正常 ✅

### T3-003 测试覆盖率提升
- **优先级**: P2
- **状态**: ⏳ 待开始
- **任务内容**:
  - [ ] e2ee 模块测试 (目标 80%)
  - [ ] federation 模块测试 (目标 80%)
  - [ ] friend_room 模块测试 (目标 80%)
  - [ ] 添加集成测试
- **验收标准**: 总覆盖率 ≥80%

### T3-004 文档完善
- **优先级**: P2
- **状态**: ⏳ 待开始
- **任务内容**:
  - [ ] 添加 OpenAPI 文档
  - [ ] 统一代码注释风格
  - [ ] 更新架构文档
  - [ ] 添加部署文档
- **验收标准**: 文档完整可读

---

## Phase 4: 低优先级问题修复 (1 周)

### T4-001 代码风格统一
- **优先级**: P3
- **状态**: ⏳ 待开始
- **任务内容**:
  - [ ] 运行 `cargo fmt`
  - [ ] 添加 pre-commit hook
  - [ ] 配置 CI 格式检查
- **验收标准**: 代码格式统一

### T4-002 依赖版本更新
- **优先级**: P3
- **状态**: ⏳ 待开始
- **任务内容**:
  - [ ] 运行 `cargo update`
  - [ ] 审查安全公告
  - [ ] 更新过旧依赖
  - [ ] 添加依赖审计 CI
- **验收标准**: 无已知安全漏洞

---

## 任务统计

| 阶段 | 任务数 | 完成数 | 状态 |
|------|--------|--------|------|
| Phase 1 | 3 | 3 | ✅ |
| Phase 2 | 5 | 4 | ⏳ |
| Phase 3 | 4 | 2 | ⏳ |
| Phase 4 | 2 | 0 | ⏳ |
| **总计** | **14** | **9** | **64%** |

---

## 依赖关系

```
Phase 1 (严重问题) ⏳
    ↓
Phase 2 (高优先级) ⏳
    ↓
Phase 3 (中优先级) ⏳
    ↓
Phase 4 (低优先级) ⏳
```

---

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Schema 修改影响现有数据 | 高 | 添加迁移脚本和回滚脚本 |
| 外键约束修改复杂 | 高 | 使用事务包装器 |
| 联邦协议实现复杂 | 中 | 参考官方 Synapse 实现 |
| 测试覆盖率提升耗时 | 中 | 优先覆盖核心模块 |
